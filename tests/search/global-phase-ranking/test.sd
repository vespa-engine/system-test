# Copyright Yahoo. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.

schema test {
    document test {
        field doc_vec type tensor<double>(d0[2]) {
            indexing: attribute | summary
        }
        field score type int {
            indexing: attribute | summary
        }
    }

    constant matrix {
        file: files/matrix.json
        type: tensor<double>(d0[2],d1[2])
    }

    document-summary minimal {
        summary documentid type string {}
    }

    rank-profile base {
        onnx-model multiply_add {
            file: files/multiply_add.onnx
            input "model_input_1": constant(matrix)
            input "model_input_2": attribute(doc_vec)
            input "model_input_3": query(query_vec)
            output "model_output_1": multiply_add_output
        }

        inputs {
            query(query_vec) tensor<double>(d0[2])
        }

        function fn_first_phase() {
            expression: -attribute(score)
        }

        first-phase {
            expression: fn_first_phase
        }

        function fn_query_vec() {
            expression: query(query_vec)
        }

        function fn_doc_vec() {
            expression: attribute(doc_vec)
        }
    }

    rank-profile global_phase inherits base {
        global-phase {
            rerank-count: 3
            expression: sum(onnx(multiply_add).multiply_add_output - fn_query_vec)
        }
    }

    # Streaming search uses a single rank phase. Emulate two rank phases.
    rank-profile emulated_second_phase inherits base {
        first-phase {
            expression: if(fn_first_phase > -4.0, sum(onnx(multiply_add).multiply_add_output - fn_query_vec), fn_first_phase)
        }
    }

    rank-profile global_phase_inverse_first_phase inherits base {
        global-phase {
            rerank-count: 5
            expression: -firstPhase
        }
    }

    rank-profile global_phase_fun inherits base {
        function foofun() {
            expression: sum(onnx(multiply_add).multiply_add_output - fn_query_vec)
        }
        global-phase {
            expression: 1 + foofun() + 2
        }
    }
    rank-profile global_phase_fun_mf inherits base {
        function foofun() {
            expression: sum(onnx(multiply_add).multiply_add_output - fn_query_vec)
        }
        global-phase {
            expression: 1 + foofun() + 2
        }
        match-features {
            foofun
        }
    }
    rank-profile global_phase_fun_mfre inherits base {
        function foofun() {
            expression: sum(onnx(multiply_add).multiply_add_output - fn_query_vec)
        }
        global-phase {
            expression: 1 + foofun() + 2
        }
        match-features {
            rankingExpression(foofun)
        }
    }

}
